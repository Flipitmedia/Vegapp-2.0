<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n - La Vega</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- NAVBAR -->
    <nav class="navbar">
        <div class="navbar-brand">
            <span class="navbar-logo">ü•¨</span>
            <span class="navbar-title">Sistema La Vega</span>
        </div>
        <div class="navbar-actions">
            <button class="btn btn--ghost" onclick="abrirBackupModal()">
                ‚öôÔ∏è Backup
            </button>
            <span class="navbar-date">{{ fecha_hoy }}</span>
        </div>
    </nav>

    <main class="container">
        <!-- HERO BANNER - Importar Pedidos -->
        <section class="hero-banner">
            <div class="hero-content">
                <h2>üì§ Importar nuevos pedidos</h2>
                <p>Sube el CSV exportado desde Shopify</p>
            </div>
            <form id="uploadForm" class="hero-actions">
                <div class="dropzone-inline" id="dropzone">
                    <input type="file" id="csvFile" accept=".csv">
                    <span class="dropzone-inline-icon">üìÑ</span>
                    <span class="dropzone-inline-text">Arrastra CSV o selecciona</span>
                    <span class="dropzone-inline-filename" id="fileName"></span>
                </div>
                <button type="submit" class="btn--hero">üì• Importar</button>
            </form>
        </section>
        
        <div id="uploadResult" class="upload-result hidden"></div>

        <!-- STATS BENTO GRID -->
        <section class="stats-bento">
            <div class="stat-bento">
                <div class="stat-bento-icon stat-bento-icon--pending">üì¶</div>
                <div class="stat-bento-value">{{ pedidos_pendientes }}</div>
                <div class="stat-bento-label">Pendientes</div>
            </div>
            <div class="stat-bento">
                <div class="stat-bento-icon stat-bento-icon--today">üöö</div>
                <div class="stat-bento-value">{{ pedidos_hoy }}</div>
                <div class="stat-bento-label">Entregas Hoy</div>
            </div>
            <div class="stat-bento">
                <div class="stat-bento-icon stat-bento-icon--delayed">‚è≥</div>
                <div class="stat-bento-value">{{ pedidos_postergados }}</div>
                <div class="stat-bento-label">Postergados</div>
            </div>
            <div class="stat-bento">
                <div class="stat-bento-icon stat-bento-icon--uncategorized">üè∑Ô∏è</div>
                <div class="stat-bento-value">{{ sin_categoria }}</div>
                <div class="stat-bento-label">Sin Categor√≠a</div>
            </div>
        </section>

        <!-- MAIN CONTENT -->
        <div class="main-layout">
            <!-- PEDIDOS POR FECHA -->
            <section class="pedidos-section">
                <div class="section-header">
                    <h2>üìÖ Pedidos por Fecha</h2>
                </div>
                <div id="fechasList" class="fechas-list">
                    <p class="text-muted text-center">Cargando...</p>
                </div>
            </section>

            <!-- SIDEBAR: Categor√≠as -->
            <aside class="sidebar">
                <div class="sidebar-card">
                    <div class="sidebar-header" onclick="toggleSidebar('categorias')">
                        <h3>üè∑Ô∏è Categor√≠as</h3>
                        <span class="sidebar-toggle" id="toggleCategorias">‚ñº</span>
                    </div>
                    <div class="sidebar-content" id="sidebarCategorias">
                        <div class="section-title">Sin asignar</div>
                        <div id="productosList" class="productos-list">
                            <p class="text-muted">Cargando...</p>
                        </div>
                        
                        <div class="section-title" style="margin-top: 1rem;">Disponibles</div>
                        <div id="categoriasList" class="categorias-grid"></div>
                        
                        <form id="nuevaCategoriaForm" class="nueva-categoria-form">
                            <input type="text" id="nuevaCategoriaInput" placeholder="Nueva..." required>
                            <button type="submit">+</button>
                        </form>
                    </div>
                </div>
            </aside>
        </div>

        <!-- DETALLE DE PEDIDOS -->
        <section id="detalleSection" class="card detalle-section hidden">
            <div class="detalle-header">
                <h2 class="card-title">
                    <span class="card-title-icon">üìã</span>
                    Pedidos del <span id="detalleFecha"></span>
                </h2>
                <button class="btn btn--ghost" onclick="cerrarDetalle()">‚úï Cerrar</button>
            </div>
            <div id="pedidosGrid" class="pedidos-grid"></div>
        </section>

        <!-- ALERTA PEDIDOS PASADOS -->
        <section id="alertaPasados" class="card alert-card hidden">
            <div class="alert-content">
                <span class="alert-icon">‚ö†Ô∏è</span>
                <div class="alert-text">
                    <strong>Hay <span id="cantidadPasados">0</span> pedidos con fecha pasada sin completar</strong>
                    <p>¬øDeseas marcarlos autom√°ticamente como completados?</p>
                </div>
                <div class="alert-actions">
                    <button class="btn btn--ghost btn--sm" onclick="cerrarAlertaPasados()">Ignorar</button>
                    <button class="btn btn--primary btn--sm" onclick="autoCompletarPasados()">‚úÖ Completar todos</button>
                </div>
            </div>
        </section>

        <!-- HISTORIAL DE COMPLETADOS -->
        <section id="completadosSection" class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <span class="card-title-icon">‚úÖ</span>
                    Pedidos Completados
                </h2>
                <button class="btn btn--ghost btn--sm" onclick="toggleCompletados()">
                    <span id="toggleCompletadosText">Mostrar</span>
                </button>
            </div>
            <div id="completadosContent" class="completados-content hidden">
                <div id="completadosList" class="completados-list">
                    <p class="text-muted">Cargando...</p>
                </div>
            </div>
        </section>

        <!-- FOOTER -->
        <footer class="footer">
            <p>Dise√±ado e implementado por <a href="https://flipit.media" target="_blank">Flipit.media</a></p>
        </footer>
    </main>

    <!-- MODAL: Asignar Categor√≠a -->
    <div id="modalCategoria" class="modal hidden">
        <div class="modal-content">
            <h3 class="modal-title">üè∑Ô∏è Asignar Categor√≠a</h3>
            <div class="modal-body">
                <p>Producto: <strong id="modalProductoNombre"></strong></p>
                <form id="asignarCategoriaForm">
                    <input type="hidden" id="modalProducto" name="producto">
                    <div class="form-group">
                        <label class="form-label">Selecciona una categor√≠a:</label>
                        <select id="modalCategoriaSelect" name="categoria_id" class="form-select" required>
                            <option value="">Seleccionar...</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn--ghost" onclick="cerrarModalCategoria()">Cancelar</button>
                <button type="submit" form="asignarCategoriaForm" class="btn btn--primary">Guardar</button>
            </div>
        </div>
    </div>

    <!-- MODAL: Postergar Pedido -->
    <div id="modalPostergar" class="modal hidden">
        <div class="modal-content">
            <h3 class="modal-title">üìÖ Postergar Pedido</h3>
            <div class="modal-body">
                <p id="postergarInfo"></p>
                <form id="postergarForm">
                    <input type="hidden" id="postergarPedidoId">
                    <div class="form-group">
                        <label class="form-label">Nueva fecha de entrega:</label>
                        <input type="date" id="postergarFecha" class="form-input" required>
                    </div>
                </form>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn--ghost" onclick="cerrarModalPostergar()">Cancelar</button>
                <button type="submit" form="postergarForm" class="btn btn--primary">Postergar</button>
            </div>
        </div>
    </div>

    <!-- MODAL: Backup -->
    <div id="modalBackup" class="modal hidden">
        <div class="modal-content modal-content--wide">
            <h3 class="modal-title">‚öôÔ∏è Configuraci√≥n de Backup</h3>
            
            <div class="backup-section">
                <h4>üì• Backup Manual</h4>
                <p class="text-muted" style="margin-bottom: 1rem; font-size: 0.85rem;">
                    Descarga un archivo Excel con todos los pedidos, categor√≠as y configuraci√≥n del sistema.
                </p>
                <div class="backup-actions">
                    <a href="/descargar/backup" class="btn btn--primary">
                        üì• Descargar Backup Ahora
                    </a>
                </div>
            </div>
            
            <div class="backup-section">
                <h4>üîÑ Restaurar Sistema</h4>
                <p class="text-muted" style="margin-bottom: 1rem; font-size: 0.85rem;">
                    Sube un archivo de backup previo para restaurar el sistema.
                </p>
                <form id="restaurarForm">
                    <div class="form-group">
                        <input type="file" id="backupFile" accept=".xlsx" class="form-input">
                    </div>
                    <label class="form-checkbox">
                        <input type="checkbox" id="autoCompletar" checked>
                        Auto-completar pedidos con fecha pasada
                    </label>
                    <div class="backup-actions" style="margin-top: 1rem;">
                        <button type="submit" class="btn btn--warning">
                            üîÑ Restaurar Sistema
                        </button>
                    </div>
                </form>
                <div id="restaurarResult" class="upload-result hidden" style="margin-top: 1rem;"></div>
            </div>
            
            <div class="backup-section">
                <h4>üìß Backup Autom√°tico</h4>
                <form id="backupConfigForm">
                    <div class="form-group">
                        <label class="form-label">Email destino:</label>
                        <input type="email" id="backupEmail" class="form-input" placeholder="tu@email.com">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Frecuencia:</label>
                            <select id="backupFrecuencia" class="form-select">
                                <option value="1">Diario</option>
                                <option value="3" selected>Cada 3 d√≠as</option>
                                <option value="7">Semanal</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Hora de env√≠o:</label>
                            <input type="time" id="backupHora" class="form-input" value="08:00">
                        </div>
                    </div>
                    <div class="backup-actions">
                        <button type="submit" class="btn btn--primary">üíæ Guardar Config</button>
                    </div>
                </form>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn btn--ghost" onclick="cerrarModalBackup()">Cerrar</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // ESTADO GLOBAL
        // ============================================
        let categorias = [];
        const HOY = new Date().toISOString().split('T')[0];

        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            cargarCategorias();
            cargarFechas();
            cargarProductosSinCategoria();
            verificarPedidosPasados();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Upload form
            document.getElementById('uploadForm').addEventListener('submit', handleUpload);
            
            // File input
            const fileInput = document.getElementById('csvFile');
            const dropzone = document.getElementById('dropzone');
            
            fileInput.addEventListener('change', (e) => {
                const fileName = e.target.files[0]?.name || '';
                const fileNameSpan = document.getElementById('fileName');
                const textSpan = dropzone.querySelector('.dropzone-inline-text');
                
                if (fileName) {
                    fileNameSpan.textContent = fileName;
                    if (textSpan) textSpan.style.display = 'none';
                    dropzone.classList.add('has-file');
                } else {
                    fileNameSpan.textContent = '';
                    if (textSpan) textSpan.style.display = '';
                    dropzone.classList.remove('has-file');
                }
            });
            
            // Drag and drop
            dropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropzone.style.background = 'rgba(255, 255, 255, 0.35)';
            });
            
            dropzone.addEventListener('dragleave', () => {
                dropzone.style.background = '';
            });
            
            dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzone.style.background = '';
                if (e.dataTransfer.files.length) {
                    fileInput.files = e.dataTransfer.files;
                    const event = new Event('change');
                    fileInput.dispatchEvent(event);
                }
            });
            
            // Nueva categor√≠a
            document.getElementById('nuevaCategoriaForm').addEventListener('submit', handleNuevaCategoria);
            
            // Asignar categor√≠a
            document.getElementById('asignarCategoriaForm').addEventListener('submit', handleAsignarCategoria);
            
            // Postergar
            document.getElementById('postergarForm').addEventListener('submit', handlePostergar);
            
            // Restaurar
            document.getElementById('restaurarForm').addEventListener('submit', handleRestaurar);
            
            // Backup config
            document.getElementById('backupConfigForm').addEventListener('submit', handleBackupConfig);
        }

        // Toggle sidebar sections
        function toggleSidebar(section) {
            const content = document.getElementById('sidebar' + section.charAt(0).toUpperCase() + section.slice(1));
            const toggle = document.getElementById('toggle' + section.charAt(0).toUpperCase() + section.slice(1));
            
            if (content) {
                content.classList.toggle('collapsed');
            }
            if (toggle) {
                toggle.classList.toggle('collapsed');
            }
        }

        // ============================================
        // API CALLS
        // ============================================
        async function cargarCategorias() {
            try {
                const res = await fetch('/api/categorias');
                categorias = await res.json();
                renderCategorias();
                actualizarSelectCategorias();
            } catch (error) {
                console.error('Error cargando categor√≠as:', error);
            }
        }

        async function cargarFechas() {
            try {
                const res = await fetch('/api/fechas-pendientes');
                const fechas = await res.json();
                renderFechas(fechas);
            } catch (error) {
                console.error('Error cargando fechas:', error);
                document.getElementById('fechasList').innerHTML = '<p class="text-muted">Error al cargar</p>';
            }
        }

        async function cargarProductosSinCategoria() {
            try {
                const res = await fetch('/api/productos-sin-categoria');
                const productos = await res.json();
                renderProductosSinCategoria(productos);
            } catch (error) {
                console.error('Error cargando productos:', error);
            }
        }

        async function cargarPedidosPorFecha(fecha) {
            try {
                const res = await fetch(`/api/pedidos?fecha=${fecha}&status=activo`);
                const pedidos = await res.json();
                renderPedidosDetalle(fecha, pedidos);
            } catch (error) {
                console.error('Error cargando pedidos:', error);
            }
        }

        // ============================================
        // HANDLERS
        // ============================================
        async function handleUpload(e) {
            e.preventDefault();
            const fileInput = document.getElementById('csvFile');
            const resultDiv = document.getElementById('uploadResult');
            
            if (!fileInput.files[0]) {
                alert('Selecciona un archivo CSV');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            
            resultDiv.className = 'upload-result upload-result--loading';
            resultDiv.textContent = '‚è≥ Procesando archivo...';
            resultDiv.classList.remove('hidden');
            
            try {
                const res = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                
                if (data.success) {
                    resultDiv.className = 'upload-result upload-result--success';
                    resultDiv.innerHTML = `
                        ‚úÖ <strong>Importaci√≥n exitosa</strong><br>
                        ${data.nuevos} pedidos nuevos importados<br>
                        ${data.duplicados > 0 ? `<small>${data.duplicados} duplicados ignorados</small><br>` : ''}
                        ${data.sin_fecha > 0 ? `<small>‚ö†Ô∏è ${data.sin_fecha} pedidos sin fecha de entrega</small>` : ''}
                    `;
                    
                    // Recargar datos
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                } else {
                    throw new Error(data.detail || 'Error desconocido');
                }
            } catch (error) {
                resultDiv.className = 'upload-result upload-result--error';
                resultDiv.textContent = `‚ùå Error: ${error.message}`;
            }
        }

        async function handleNuevaCategoria(e) {
            e.preventDefault();
            const input = document.getElementById('nuevaCategoriaInput');
            const nombre = input.value.trim();
            
            if (!nombre) return;
            
            const formData = new FormData();
            formData.append('nombre', nombre);
            
            try {
                const res = await fetch('/api/categorias', {
                    method: 'POST',
                    body: formData
                });
                
                if (res.ok) {
                    input.value = '';
                    cargarCategorias();
                } else {
                    alert('Error al crear categor√≠a. ¬øYa existe?');
                }
            } catch (error) {
                alert('Error de conexi√≥n');
            }
        }

        async function handleAsignarCategoria(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            try {
                const res = await fetch('/api/asignar-categoria', {
                    method: 'POST',
                    body: formData
                });
                
                if (res.ok) {
                    cerrarModalCategoria();
                    cargarProductosSinCategoria();
                    // Actualizar contador
                    setTimeout(() => location.reload(), 500);
                }
            } catch (error) {
                alert('Error al asignar categor√≠a');
            }
        }

        async function handlePostergar(e) {
            e.preventDefault();
            const pedidoId = document.getElementById('postergarPedidoId').value;
            const nuevaFecha = document.getElementById('postergarFecha').value;
            
            const formData = new FormData();
            formData.append('nueva_fecha', nuevaFecha);
            
            try {
                const res = await fetch(`/api/pedidos/${pedidoId}/postergar`, {
                    method: 'POST',
                    body: formData
                });
                
                if (res.ok) {
                    cerrarModalPostergar();
                    location.reload();
                }
            } catch (error) {
                alert('Error al postergar pedido');
            }
        }

        async function handleRestaurar(e) {
            e.preventDefault();
            const fileInput = document.getElementById('backupFile');
            const resultDiv = document.getElementById('restaurarResult');
            
            if (!fileInput.files[0]) {
                alert('Selecciona un archivo de backup');
                return;
            }
            
            if (!confirm('¬øEst√°s seguro? Esto sobrescribir√° los datos actuales.')) return;
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('auto_completar', document.getElementById('autoCompletar').checked);
            
            resultDiv.className = 'upload-result upload-result--loading';
            resultDiv.textContent = '‚è≥ Restaurando...';
            resultDiv.classList.remove('hidden');
            
            try {
                const res = await fetch('/api/backup/restaurar', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                
                if (data.success) {
                    resultDiv.className = 'upload-result upload-result--success';
                    resultDiv.innerHTML = `
                        ‚úÖ Restauraci√≥n completada<br>
                        ${data.estadisticas.pedidos} pedidos restaurados<br>
                        ${data.estadisticas.auto_completados > 0 ? `${data.estadisticas.auto_completados} auto-completados` : ''}
                    `;
                    setTimeout(() => location.reload(), 2000);
                }
            } catch (error) {
                resultDiv.className = 'upload-result upload-result--error';
                resultDiv.textContent = `‚ùå Error: ${error.message}`;
            }
        }

        async function handleBackupConfig(e) {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('email', document.getElementById('backupEmail').value);
            formData.append('frecuencia_dias', document.getElementById('backupFrecuencia').value);
            formData.append('hora', document.getElementById('backupHora').value);
            
            try {
                const res = await fetch('/api/backup/config', {
                    method: 'POST',
                    body: formData
                });
                
                if (res.ok) {
                    alert('‚úÖ Configuraci√≥n guardada');
                }
            } catch (error) {
                alert('Error al guardar configuraci√≥n');
            }
        }

        async function completarPedido(id) {
            if (!confirm('¬øMarcar este pedido como completado?')) return;
            
            try {
                await fetch(`/api/pedidos/${id}/completar`, { method: 'POST' });
                location.reload();
            } catch (error) {
                alert('Error al completar pedido');
            }
        }

        // ============================================
        // RENDERS
        // ============================================
        function renderCategorias() {
            const container = document.getElementById('categoriasList');
            
            const colorMap = {
                'Frutas': 'frutas',
                'Verduras': 'verduras',
                'Carnes': 'carnes',
                'L√°cteos': 'lacteos',
                'Abarrotes': 'abarrotes',
                'Congelados': 'congelados',
                'Otros': 'otros'
            };
            
            container.innerHTML = categorias.map(cat => {
                const colorClass = colorMap[cat.nombre] || 'otros';
                return `<span class="categoria-tag categoria-tag--${colorClass}">${cat.nombre}</span>`;
            }).join('');
        }

        function renderFechas(fechas) {
            const container = document.getElementById('fechasList');
            
            if (fechas.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No hay pedidos pendientes</p>';
                return;
            }
            
            const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            
            container.innerHTML = fechas.map(f => {
                const esHoy = f.fecha === HOY;
                const fechaObj = new Date(f.fecha + 'T12:00:00');
                const dias = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
                const diaNombre = dias[fechaObj.getDay()];
                const diaNumero = fechaObj.getDate();
                const mes = meses[fechaObj.getMonth()];
                
                return `
                    <div class="fecha-ticket ${esHoy ? 'fecha-ticket--today' : ''}">
                        <div class="fecha-circle">
                            <span class="fecha-circle-day">${diaNumero}</span>
                            <span class="fecha-circle-month">${mes}</span>
                        </div>
                        <div class="fecha-info">
                            <span class="fecha-weekday">${diaNombre}</span>
                            <span class="fecha-count">${f.cantidad} pedido${f.cantidad > 1 ? 's' : ''}</span>
                            <div class="fecha-badges">
                                ${esHoy ? '<span class="badge badge--today">HOY</span>' : ''}
                                ${f.postergados > 0 ? `<span class="badge badge--postergado">${f.postergados} postergado${f.postergados > 1 ? 's' : ''}</span>` : ''}
                            </div>
                        </div>
                        <div class="fecha-actions">
                            <button class="btn--icon-sm" onclick="verPedidos('${f.fecha}')" title="Ver pedidos">
                                üëÅÔ∏è
                            </button>
                            <a href="/descargar/lista-compras/${f.fecha}" class="btn--icon-sm" title="Lista de compras">
                                üõí
                            </a>
                            <a href="/descargar/pedidos-armado/${f.fecha}" class="btn--pill btn--pill-primary">
                                üì¶ Armado
                            </a>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderProductosSinCategoria(productos) {
            const container = document.getElementById('productosList');
            
            if (productos.length === 0) {
                container.innerHTML = `
                    <div class="productos-empty">
                        ‚úÖ Todos los productos tienen categor√≠a
                    </div>
                `;
                return;
            }
            
            container.innerHTML = productos.map(p => `
                <div class="producto-item">
                    <span class="producto-name">${p}</span>
                    <button class="btn--assign" onclick="abrirModalCategoria('${escapeHtml(p)}')">
                        Asignar
                    </button>
                </div>
            `).join('');
        }

        function renderPedidosDetalle(fecha, pedidos) {
            const section = document.getElementById('detalleSection');
            const container = document.getElementById('pedidosGrid');
            
            // Formatear fecha
            const fechaObj = new Date(fecha + 'T12:00:00');
            const dias = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
            const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            document.getElementById('detalleFecha').textContent = 
                `${dias[fechaObj.getDay()]} ${fechaObj.getDate()} ${meses[fechaObj.getMonth()]}`;
            
            if (pedidos.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No hay pedidos para esta fecha</p>';
            } else {
                container.innerHTML = pedidos.map(p => `
                    <div class="pedido-card ${p.status === 'postergado' ? 'pedido-card--postergado' : ''}">
                        <div class="pedido-header">
                            <span class="pedido-number">${p.order_number}</span>
                            <span class="pedido-cliente">${p.nombre_cliente || 'Sin nombre'}</span>
                            <span class="badge badge--comuna">${p.comuna || 'Sin comuna'}</span>
                            ${p.status === 'postergado' ? '<span class="badge badge--postergado">Postergado</span>' : ''}
                        </div>
                        
                        ${p.direccion ? `
                            <div class="pedido-direccion">
                                <span>üìç</span>
                                <span>${p.direccion}</span>
                            </div>
                        ` : ''}
                        
                        <ul class="pedido-items">
                            ${p.items.map(item => `
                                <li>
                                    <strong>${item.cantidad}x</strong>
                                    <span>${item.producto}</span>
                                </li>
                            `).join('')}
                        </ul>
                        
                        <div class="pedido-actions">
                            <button class="btn btn--ghost btn--sm" onclick="abrirModalPostergar(${p.id}, '${p.order_number}')">
                                üìÖ Postergar
                            </button>
                            <button class="btn btn--primary btn--sm" onclick="completarPedido(${p.id})">
                                ‚úÖ Completado
                            </button>
                        </div>
                    </div>
                `).join('');
            }
            
            section.classList.remove('hidden');
            section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function actualizarSelectCategorias() {
            const select = document.getElementById('modalCategoriaSelect');
            select.innerHTML = '<option value="">Seleccionar categor√≠a...</option>' +
                categorias.map(c => `<option value="${c.id}">${c.nombre}</option>`).join('');
        }

        // ============================================
        // MODALES
        // ============================================
        function verPedidos(fecha) {
            cargarPedidosPorFecha(fecha);
        }

        function cerrarDetalle() {
            document.getElementById('detalleSection').classList.add('hidden');
        }

        function abrirModalCategoria(producto) {
            document.getElementById('modalProducto').value = producto;
            document.getElementById('modalProductoNombre').textContent = producto;
            document.getElementById('modalCategoria').classList.remove('hidden');
        }

        function cerrarModalCategoria() {
            document.getElementById('modalCategoria').classList.add('hidden');
        }

        function abrirModalPostergar(id, orderNumber) {
            document.getElementById('postergarPedidoId').value = id;
            document.getElementById('postergarInfo').textContent = `Pedido: ${orderNumber}`;
            
            // Fecha m√≠nima: ma√±ana
            const manana = new Date();
            manana.setDate(manana.getDate() + 1);
            document.getElementById('postergarFecha').min = manana.toISOString().split('T')[0];
            document.getElementById('postergarFecha').value = '';
            
            document.getElementById('modalPostergar').classList.remove('hidden');
        }

        function cerrarModalPostergar() {
            document.getElementById('modalPostergar').classList.add('hidden');
        }

        function abrirBackupModal() {
            cargarBackupConfig();
            document.getElementById('modalBackup').classList.remove('hidden');
        }

        function cerrarModalBackup() {
            document.getElementById('modalBackup').classList.add('hidden');
        }

        async function cargarBackupConfig() {
            try {
                const res = await fetch('/api/backup/config');
                const config = await res.json();
                document.getElementById('backupEmail').value = config.email || '';
                document.getElementById('backupFrecuencia').value = config.frecuencia_dias || 3;
                document.getElementById('backupHora').value = config.hora || '08:00';
            } catch (error) {
                console.error('Error cargando config backup:', error);
            }
        }

        // ============================================
        // UTILIDADES
        // ============================================
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/'/g, "\\'");
        }

        // Cerrar modales con Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                cerrarModalCategoria();
                cerrarModalPostergar();
                cerrarModalBackup();
            }
        });

        // Cerrar modales haciendo clic fuera
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                }
            });
        });

        // ============================================
        // PEDIDOS COMPLETADOS Y PASADOS
        // ============================================
        async function verificarPedidosPasados() {
            try {
                const res = await fetch('/api/pedidos-pasados-pendientes');
                const data = await res.json();
                
                if (data.cantidad > 0) {
                    document.getElementById('cantidadPasados').textContent = data.cantidad;
                    document.getElementById('alertaPasados').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error verificando pedidos pasados:', error);
            }
        }

        async function autoCompletarPasados() {
            try {
                const res = await fetch('/api/auto-completar-pasados', { method: 'POST' });
                const data = await res.json();
                
                if (data.success) {
                    alert(`‚úÖ Se completaron ${data.completados} pedidos autom√°ticamente`);
                    location.reload();
                }
            } catch (error) {
                alert('Error al auto-completar pedidos');
            }
        }

        function cerrarAlertaPasados() {
            document.getElementById('alertaPasados').classList.add('hidden');
        }

        let completadosVisible = false;

        function toggleCompletados() {
            const content = document.getElementById('completadosContent');
            const btnText = document.getElementById('toggleCompletadosText');
            
            completadosVisible = !completadosVisible;
            
            if (completadosVisible) {
                content.classList.remove('hidden');
                btnText.textContent = 'Ocultar';
                cargarPedidosCompletados();
            } else {
                content.classList.add('hidden');
                btnText.textContent = 'Mostrar';
            }
        }

        async function cargarPedidosCompletados() {
            try {
                const res = await fetch('/api/pedidos-completados?limit=30');
                const pedidos = await res.json();
                renderPedidosCompletados(pedidos);
            } catch (error) {
                console.error('Error cargando completados:', error);
            }
        }

        function renderPedidosCompletados(pedidos) {
            const container = document.getElementById('completadosList');
            
            if (pedidos.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No hay pedidos completados</p>';
                return;
            }
            
            container.innerHTML = `
                <table class="completados-table">
                    <thead>
                        <tr>
                            <th>Pedido</th>
                            <th>Cliente</th>
                            <th>Comuna</th>
                            <th>Fecha Entrega</th>
                            <th>Completado</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        ${pedidos.map(p => {
                            const completadoDate = p.completed_at ? new Date(p.completed_at).toLocaleDateString('es-CL') : '-';
                            return `
                                <tr>
                                    <td><strong>${p.order_number}</strong></td>
                                    <td>${p.nombre_cliente || '-'}</td>
                                    <td>${p.comuna || '-'}</td>
                                    <td>${p.fecha_entrega || '-'}</td>
                                    <td>${completadoDate}</td>
                                    <td>
                                        <button class="btn btn--ghost btn--sm" onclick="reactivarPedido(${p.id}, '${p.order_number}')" title="Deshacer completado">
                                            ‚Ü©Ô∏è Deshacer
                                        </button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        async function reactivarPedido(id, orderNumber) {
            if (!confirm(`¬øReactivar el pedido ${orderNumber}? Volver√° a aparecer como pendiente.`)) return;
            
            try {
                const res = await fetch(`/api/pedidos/${id}/reactivar`, { method: 'POST' });
                
                if (res.ok) {
                    alert('‚úÖ Pedido reactivado');
                    location.reload();
                }
            } catch (error) {
                alert('Error al reactivar pedido');
            }
        }
    </script>
</body>
</html>
