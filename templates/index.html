<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n - La Vega</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>
    <nav class="navbar">
        <div class="navbar-brand">
            <span class="logo">ü•¨</span>
            <span class="brand-text">Sistema La Vega</span>
        </div>
        <div class="navbar-actions">
            <button class="btn btn-ghost" onclick="abrirConfigBackup()">‚öôÔ∏è Backup</button>
            <span class="navbar-date">{{ fecha_hoy }}</span>
        </div>
    </nav>

    <main class="container">
        <section class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üì¶</div>
                <div class="stat-content">
                    <div class="stat-value">{{ pedidos_pendientes }}</div>
                    <div class="stat-label">Pedidos Pendientes</div>
                </div>
            </div>
            <div class="stat-card stat-today">
                <div class="stat-icon">üöö</div>
                <div class="stat-content">
                    <div class="stat-value">{{ pedidos_hoy }}</div>
                    <div class="stat-label">Entregas Hoy</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìÖ</div>
                <div class="stat-content">
                    <div class="stat-value">{{ fechas_pendientes }}</div>
                    <div class="stat-label">Fechas con Pedidos</div>
                </div>
            </div>
            <div class="stat-card {% if sin_categoria > 0 %}stat-warning{% endif %}">
                <div class="stat-icon">üè∑Ô∏è</div>
                <div class="stat-content">
                    <div class="stat-value">{{ sin_categoria }}</div>
                    <div class="stat-label">Sin Categor√≠a</div>
                </div>
            </div>
        </section>

        <section class="card upload-section">
            <h2>üì§ Importar Pedidos</h2>
            <p class="text-muted">Sube el archivo CSV exportado desde Shopify</p>
            <form id="upload-form" class="upload-form">
                <div class="dropzone" id="dropzone">
                    <input type="file" id="csv-file" accept=".csv" required>
                    <div class="dropzone-content">
                        <span class="dropzone-icon">üìÑ</span>
                        <span class="dropzone-text">Arrastra tu archivo CSV aqu√≠</span>
                        <span class="dropzone-subtext">o haz clic para seleccionar</span>
                    </div>
                    <span class="file-name" id="file-name"></span>
                </div>
                <button type="submit" class="btn btn-primary btn-import">Importar Pedidos</button>
            </form>
            <div id="upload-result" class="upload-result hidden"></div>
        </section>

        <div class="content-grid">
            <section class="card">
                <h2>üìÖ Pedidos por Fecha</h2>
                <div id="fechas-list" class="fechas-list"><p class="text-muted">Cargando...</p></div>
            </section>
            <section class="card">
                <h2>üè∑Ô∏è Gesti√≥n de Categor√≠as</h2>
                <div id="productos-sin-categoria" class="productos-sin-categoria">
                    <h3>Productos sin asignar</h3>
                    <div id="productos-lista" class="productos-lista"><p class="text-muted">No hay productos sin categor√≠a</p></div>
                </div>
                <div class="categorias-section">
                    <h3>Categor√≠as disponibles</h3>
                    <div id="categorias-lista" class="categorias-lista"></div>
                    <form id="nueva-categoria-form" class="nueva-categoria-form">
                        <input type="text" id="nueva-categoria" placeholder="Nueva categor√≠a..." required>
                        <button type="submit" class="btn btn-small">+ Agregar</button>
                    </form>
                </div>
            </section>
        </div>

        <section class="card" id="detalle-section" style="display: none;">
            <div class="detalle-header">
                <h2>üìã Pedidos del <span id="detalle-fecha"></span></h2>
                <button class="btn btn-ghost" onclick="cerrarDetalle()">‚úï Cerrar</button>
            </div>
            <div id="pedidos-detalle" class="pedidos-detalle"></div>
        </section>

        <footer class="footer">
            <p>Dise√±ado e implementado por <a href="https://flipit.media" target="_blank">Flipit.media</a></p>
        </footer>
    </main>

    <div id="modal-categoria" class="modal hidden">
        <div class="modal-content">
            <h3>Asignar Categor√≠a</h3>
            <p id="modal-producto-nombre"></p>
            <form id="asignar-form">
                <input type="hidden" id="modal-producto" name="producto">
                <select id="modal-categoria-select" name="categoria_id" required><option value="">Seleccionar...</option></select>
                <div class="modal-actions">
                    <button type="button" class="btn btn-ghost" onclick="cerrarModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-postergar" class="modal hidden">
        <div class="modal-content">
            <h3>Postergar Pedido</h3>
            <p id="postergar-pedido-info"></p>
            <form id="postergar-form">
                <input type="hidden" id="postergar-pedido-id">
                <label>Nueva fecha de entrega:</label>
                <input type="date" id="postergar-fecha" required>
                <div class="modal-actions">
                    <button type="button" class="btn btn-ghost" onclick="cerrarModalPostergar()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Postergar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-backup" class="modal hidden">
        <div class="modal-content modal-wide">
            <h3>‚öôÔ∏è Configuraci√≥n de Backup</h3>
            <div class="backup-section">
                <h4>Backup Manual</h4>
                <div class="backup-actions"><a href="/descargar/backup" class="btn btn-primary">üì• Descargar Backup</a></div>
            </div>
            <div class="backup-section">
                <h4>Restaurar Sistema</h4>
                <form id="restaurar-form" class="restaurar-form">
                    <div class="dropzone dropzone-small" id="dropzone-backup">
                        <input type="file" id="backup-file" accept=".xlsx">
                        <div class="dropzone-content"><span class="dropzone-text">Seleccionar backup (.xlsx)</span></div>
                    </div>
                    <label class="checkbox-label"><input type="checkbox" id="auto-completar" checked> Auto-completar pedidos pasados</label>
                    <button type="submit" class="btn btn-warning">üîÑ Restaurar</button>
                </form>
                <div id="restaurar-result" class="upload-result hidden"></div>
            </div>
            <div class="backup-section">
                <h4>Backup Autom√°tico por Email</h4>
                <form id="backup-config-form">
                    <div class="form-group"><label>Email destino:</label><input type="email" id="backup-email" placeholder="tu@email.com"></div>
                    <div class="form-row">
                        <div class="form-group"><label>Frecuencia:</label><select id="backup-frecuencia"><option value="1">Diario</option><option value="3" selected>Cada 3 d√≠as</option><option value="7">Semanal</option></select></div>
                        <div class="form-group"><label>Hora:</label><input type="time" id="backup-hora" value="08:00"></div>
                    </div>
                    <details class="smtp-details"><summary>Config SMTP (Gmail)</summary>
                        <div class="form-group"><label>Email remitente:</label><input type="email" id="smtp-user" placeholder="tu@gmail.com"></div>
                        <div class="form-group"><label>Contrase√±a app:</label><input type="password" id="smtp-password"><small><a href="https://myaccount.google.com/apppasswords" target="_blank">Generar en Google</a></small></div>
                    </details>
                    <div class="backup-actions"><button type="submit" class="btn btn-primary">üíæ Guardar</button><button type="button" class="btn btn-secondary" onclick="enviarBackupAhora()">üìß Enviar Ahora</button></div>
                </form>
                <p id="ultimo-backup" class="text-muted"></p>
            </div>
            <div class="modal-actions"><button type="button" class="btn btn-ghost" onclick="cerrarModalBackup()">Cerrar</button></div>
        </div>
    </div>

    <script>
        let categorias = [];
        document.addEventListener('DOMContentLoaded', () => {
            cargarCategorias(); cargarFechas(); cargarProductosSinCategoria();
            document.getElementById('upload-form').addEventListener('submit', handleUpload);
            document.getElementById('nueva-categoria-form').addEventListener('submit', handleNuevaCategoria);
            document.getElementById('asignar-form').addEventListener('submit', handleAsignarCategoria);
            document.getElementById('postergar-form').addEventListener('submit', handlePostergar);
            document.getElementById('restaurar-form').addEventListener('submit', handleRestaurar);
            document.getElementById('backup-config-form').addEventListener('submit', handleGuardarBackupConfig);
            document.getElementById('csv-file').addEventListener('change', (e) => {
                const fileName = e.target.files[0]?.name || '';
                document.getElementById('file-name').textContent = fileName;
                if (fileName) document.getElementById('dropzone').classList.add('has-file');
            });
            const dropzone = document.getElementById('dropzone');
            dropzone.addEventListener('click', () => document.getElementById('csv-file').click());
            dropzone.addEventListener('dragover', (e) => { e.preventDefault(); dropzone.classList.add('dragover'); });
            dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragover'));
            dropzone.addEventListener('drop', (e) => { e.preventDefault(); dropzone.classList.remove('dragover'); if (e.dataTransfer.files.length) { document.getElementById('csv-file').files = e.dataTransfer.files; document.getElementById('file-name').textContent = e.dataTransfer.files[0].name; dropzone.classList.add('has-file'); }});
        });

        async function cargarCategorias() { const res = await fetch('/api/categorias'); categorias = await res.json(); renderCategorias(); actualizarSelectCategorias(); }
        async function cargarFechas() { const res = await fetch('/api/fechas-pendientes'); const fechas = await res.json(); renderFechas(fechas); }
        async function cargarProductosSinCategoria() { const res = await fetch('/api/productos-sin-categoria'); const productos = await res.json(); renderProductosSinCategoria(productos); }
        async function cargarPedidosFecha(fecha) { const res = await fetch(`/api/pedidos?fecha=${fecha}&status=activo`); const pedidos = await res.json(); renderPedidosDetalle(fecha, pedidos); }
        async function cargarBackupConfig() { const res = await fetch('/api/backup/config'); const config = await res.json(); document.getElementById('backup-email').value = config.email || ''; document.getElementById('backup-frecuencia').value = config.frecuencia_dias || 3; document.getElementById('backup-hora').value = config.hora || '08:00'; if (config.ultimo_backup) { const fecha = new Date(config.ultimo_backup); document.getElementById('ultimo-backup').textContent = `√öltimo backup: ${fecha.toLocaleDateString('es-CL')} ${fecha.toLocaleTimeString('es-CL')}`; }}

        async function handleUpload(e) { e.preventDefault(); const fileInput = document.getElementById('csv-file'); const resultDiv = document.getElementById('upload-result'); if (!fileInput.files[0]) return; const formData = new FormData(); formData.append('file', fileInput.files[0]); resultDiv.className = 'upload-result loading'; resultDiv.innerHTML = '‚è≥ Procesando...'; try { const res = await fetch('/upload', { method: 'POST', body: formData }); const data = await res.json(); if (data.success) { resultDiv.className = 'upload-result success'; resultDiv.innerHTML = `‚úÖ ${data.nuevos} pedidos nuevos importados`; setTimeout(() => location.reload(), 1500); } else throw new Error(data.detail); } catch (error) { resultDiv.className = 'upload-result error'; resultDiv.innerHTML = `‚ùå ${error.message}`; }}
        async function handleNuevaCategoria(e) { e.preventDefault(); const input = document.getElementById('nueva-categoria'); const formData = new FormData(); formData.append('nombre', input.value.trim()); const res = await fetch('/api/categorias', { method: 'POST', body: formData }); if (res.ok) { input.value = ''; cargarCategorias(); }}
        async function handleAsignarCategoria(e) { e.preventDefault(); const res = await fetch('/api/asignar-categoria', { method: 'POST', body: new FormData(e.target) }); if (res.ok) { cerrarModal(); location.reload(); }}
        async function handlePostergar(e) { e.preventDefault(); const formData = new FormData(); formData.append('nueva_fecha', document.getElementById('postergar-fecha').value); const res = await fetch(`/api/pedidos/${document.getElementById('postergar-pedido-id').value}/postergar`, { method: 'POST', body: formData }); if (res.ok) { cerrarModalPostergar(); location.reload(); }}
        async function handleRestaurar(e) { e.preventDefault(); const fileInput = document.getElementById('backup-file'); const resultDiv = document.getElementById('restaurar-result'); if (!fileInput.files[0]) { alert('Selecciona un archivo'); return; } if (!confirm('¬øSobrescribir datos actuales?')) return; const formData = new FormData(); formData.append('file', fileInput.files[0]); formData.append('auto_completar', document.getElementById('auto-completar').checked); resultDiv.className = 'upload-result loading'; resultDiv.innerHTML = '‚è≥ Restaurando...'; try { const res = await fetch('/api/backup/restaurar', { method: 'POST', body: formData }); const data = await res.json(); if (data.success) { resultDiv.className = 'upload-result success'; resultDiv.innerHTML = `‚úÖ Restaurado: ${data.estadisticas.pedidos} pedidos`; setTimeout(() => location.reload(), 1500); } } catch (error) { resultDiv.className = 'upload-result error'; resultDiv.innerHTML = `‚ùå ${error.message}`; }}
        async function handleGuardarBackupConfig(e) { e.preventDefault(); const formData = new FormData(); formData.append('email', document.getElementById('backup-email').value); formData.append('frecuencia_dias', document.getElementById('backup-frecuencia').value); formData.append('hora', document.getElementById('backup-hora').value); formData.append('smtp_user', document.getElementById('smtp-user').value); formData.append('smtp_password', document.getElementById('smtp-password').value); const res = await fetch('/api/backup/config', { method: 'POST', body: formData }); if (res.ok) alert('‚úÖ Guardado'); }
        async function enviarBackupAhora() { try { const res = await fetch('/api/backup/enviar-ahora', { method: 'POST' }); const data = await res.json(); alert(data.success ? `‚úÖ ${data.mensaje}` : `‚ùå ${data.detail}`); } catch (error) { alert(`‚ùå ${error.message}`); }}

        function renderCategorias() { const colores = {'Frutas':'cat-frutas','Verduras':'cat-verduras','Carnes':'cat-carnes','L√°cteos':'cat-lacteos','Abarrotes':'cat-abarrotes','Congelados':'cat-congelados'}; document.getElementById('categorias-lista').innerHTML = categorias.map(c => `<div class="categoria-tag ${colores[c.nombre]||''}">${c.nombre}</div>`).join(''); }
        function renderFechas(fechas) { const container = document.getElementById('fechas-list'); if (!fechas.length) { container.innerHTML = '<p class="text-muted">No hay pedidos pendientes</p>'; return; } const hoy = new Date().toISOString().split('T')[0]; container.innerHTML = fechas.map(f => `<div class="fecha-item ${f.fecha===hoy?'fecha-hoy':''}"><div class="fecha-info"><div class="fecha-dia"><span class="fecha-dia-nombre">${getDiaNombre(f.fecha)}</span><span class="fecha-dia-numero">${getDiaNumero(f.fecha)}</span></div><div class="fecha-meta"><span class="fecha-count">${f.cantidad} pedido${f.cantidad>1?'s':''}</span>${f.postergados>0?`<span class="badge-postergado">${f.postergados} postergado${f.postergados>1?'s':''}</span>`:''}${f.fecha===hoy?'<span class="badge-hoy">HOY</span>':''}</div></div><div class="fecha-actions"><button class="btn btn-icon" onclick="verPedidos('${f.fecha}')" title="Ver">üëÅÔ∏è</button><a href="/descargar/lista-compras/${f.fecha}" class="btn btn-icon" title="Compras">üõí</a><a href="/descargar/pedidos-armado/${f.fecha}" class="btn btn-primary btn-small">üì¶ Armado</a></div></div>`).join(''); }
        function renderProductosSinCategoria(productos) { const container = document.getElementById('productos-lista'); if (!productos.length) { container.innerHTML = '<p class="text-muted">‚úÖ Todos categorizados</p>'; return; } container.innerHTML = productos.map(p => `<div class="producto-item"><span class="producto-nombre">${p}</span><button class="btn btn-small btn-secondary" onclick="abrirModalCategoria('${p.replace(/'/g,"\\'")}')">Asignar</button></div>`).join(''); }
        function renderPedidosDetalle(fecha, pedidos) { document.getElementById('detalle-fecha').textContent = formatFecha(fecha); document.getElementById('pedidos-detalle').innerHTML = pedidos.map(p => `<div class="pedido-card ${p.status==='postergado'?'pedido-postergado':''}"><div class="pedido-header"><strong>${p.order_number}</strong><span class="pedido-cliente">${p.nombre_cliente||'Sin nombre'}</span><span class="badge">${p.comuna||'Sin comuna'}</span>${p.status==='postergado'?'<span class="badge-postergado">Postergado</span>':''}</div>${p.direccion?`<div class="pedido-direccion">üìç ${p.direccion}</div>`:''}<ul class="pedido-items">${p.items.map(i=>`<li><strong>${i.cantidad}x</strong> ${i.producto}</li>`).join('')}</ul><div class="pedido-actions"><button class="btn btn-small btn-ghost" onclick="abrirModalPostergar(${p.id},'${p.order_number}')">üìÖ Postergar</button><button class="btn btn-small btn-primary" onclick="completarPedido(${p.id})">‚úÖ Listo</button></div></div>`).join(''); document.getElementById('detalle-section').style.display = 'block'; document.getElementById('detalle-section').scrollIntoView({behavior:'smooth'}); }
        function actualizarSelectCategorias() { document.getElementById('modal-categoria-select').innerHTML = '<option value="">Seleccionar...</option>' + categorias.map(c => `<option value="${c.id}">${c.nombre}</option>`).join(''); }

        function verPedidos(fecha) { cargarPedidosFecha(fecha); }
        function cerrarDetalle() { document.getElementById('detalle-section').style.display = 'none'; }
        function abrirModalCategoria(producto) { document.getElementById('modal-producto').value = producto; document.getElementById('modal-producto-nombre').textContent = producto; document.getElementById('modal-categoria').classList.remove('hidden'); }
        function cerrarModal() { document.getElementById('modal-categoria').classList.add('hidden'); }
        function abrirModalPostergar(id, order) { document.getElementById('postergar-pedido-id').value = id; document.getElementById('postergar-pedido-info').textContent = `Pedido: ${order}`; const m = new Date(); m.setDate(m.getDate()+1); document.getElementById('postergar-fecha').min = m.toISOString().split('T')[0]; document.getElementById('modal-postergar').classList.remove('hidden'); }
        function cerrarModalPostergar() { document.getElementById('modal-postergar').classList.add('hidden'); }
        function abrirConfigBackup() { cargarBackupConfig(); document.getElementById('modal-backup').classList.remove('hidden'); }
        function cerrarModalBackup() { document.getElementById('modal-backup').classList.add('hidden'); }
        async function completarPedido(id) { if (!confirm('¬øMarcar como completado?')) return; await fetch(`/api/pedidos/${id}/completar`, {method:'POST'}); location.reload(); }

        function formatFecha(f) { const d = new Date(f+'T12:00:00'); const dias = ['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b']; const meses = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic']; return `${dias[d.getDay()]} ${d.getDate()} ${meses[d.getMonth()]}`; }
        function getDiaNombre(f) { return ['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'][new Date(f+'T12:00:00').getDay()]; }
        function getDiaNumero(f) { return new Date(f+'T12:00:00').getDate(); }
    </script>
</body>
</html>
